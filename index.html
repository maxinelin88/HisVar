<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Historical VaR Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0d1117;
            --panel-bg: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --text-dim: #8b949e;
            --red: #f85149;
            --green: #3fb950;
            --blue: #58a6ff;
            --yellow: #d29922;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-size: 13px;
        }

        /* 顶部导航 */
        .top-nav {
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-area {
            font-weight: bold;
            color: white;
            font-size: 14px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 参数分组容器 */
        .param-section {
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid var(--border);
            padding-right: 15px;
        }
        
        .param-section:last-child { border-right: none; }

        .label { 
            color: var(--text-dim); 
            font-weight: 600; 
            font-size: 11px; 
            text-transform: uppercase;
            white-space: nowrap;
        }

        /* 输入控件样式 */
        select, input {
            background: #010409;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 5px 10px;
            border-radius: 4px;
            outline: none;
            font-size: 12px;
            transition: all 0.2s;
        }

        select:focus, input:focus {
            border-color: var(--blue);
        }

        /* 禁用状态样式 */
        select:disabled {
            background: #1c2128;
            color: #484f58;
            cursor: not-allowed;
            border-color: transparent;
        }

        .btn-run {
            background: #238636;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-run:hover { background: #2ea043; }

        /* 内容布局 */
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .grid-container { flex: 1; overflow: auto; padding: 10px; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #21262d; text-align: left; padding: 10px; position: sticky; top: 0; border-bottom: 2px solid var(--border); z-index: 10;}
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        tr:hover { background-color: rgba(110, 118, 129, 0.1); cursor: pointer; }

        .method-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(88, 166, 255, 0.15); color: var(--blue); border: 1px solid rgba(88, 166, 255, 0.3); }

        /* 底部面板 */
        .analysis-drawer {
            height: 300px;
            background: #0d1117;
            border-top: 1px solid var(--border);
            display: flex;
            padding: 15px;
            gap: 20px;
        }

        .chart-box { flex: 2; position: relative; }
        .stats-box { flex: 1; background: #161b22; border-radius: 8px; padding: 15px; border: 1px solid var(--border); overflow-y: auto;}

        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dotted var(--border); padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="top-nav">
    <div class="nav-left">
        <div class="logo-area"><i class="fas fa-layer-group"></i> RiskEngine</div>
        
        <div class="param-section">
            <span class="label" title="Select Entity Scope">Scope</span>
            <select id="customerSelect" onchange="handleCustomerChange()">
                <option value="" selected disabled>Select Customer</option>
                <option value="AAAA">Customer AAAA</option>
                <option value="BBBB">Customer BBBB</option>
                <option value="CCCC">Customer CCCC</option>
            </select>
            
            <select id="accountSelect" disabled onchange="handleAccountChange()">
                <option value="">-- Select Customer First --</option>
            </select>
        </div>

        <div class="param-section">
            <span class="label">Params</span>
            <select id="lookback">
                <option value="252">1Y (252D)</option>
                <option value="504">2Y (504D)</option>
            </select>
            <select id="confidence">
                <option value="0.99">99% Conf</option>
                <option value="0.95">95% Conf</option>
            </select>
            <input type="text" id="pnl_days" value="1D" style="width: 30px; text-align: center;" title="Holding Period">
        </div>
    </div>

    <button class="btn-run" onclick="simulateCalc()"><i class="fas fa-play"></i> CALC</button>
</div>

<div class="content">
    <div class="grid-container">
        <table>
            <thead>
                <tr>
                    <th>Asset Hierarchy</th>
                    <th>VaR (USD)</th>
                    <th>Contribution</th>
                    <th>Method</th>
                    <th>Scenario PnL</th>
                    <th>days_eff</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background: rgba(56, 139, 253, 0.1);" onclick="updateDetail('Portfolio Total', 1.0)">
                    <td><strong><i class="fas fa-wallet"></i> <span id="portfolioName">ALL ACCOUNTS</span></strong></td>
                    <td style="color: var(--red); font-weight: bold;">(1,420,500)</td>
                    <td>100%</td>
                    <td>Aggregated</td>
                    <td>-1,450,200</td>
                    <td>251</td>
                </tr>
                <tr onclick="updateDetail('NVDA', 1.2)">
                    <td style="padding-left: 25px;"><i class="fas fa-share-alt"></i> NVDA</td>
                    <td>(980,000)</td>
                    <td>68.9%</td>
                    <td><span class="method-badge">Actual</span></td>
                    <td>-1,020,000</td>
                    <td>251</td>
                </tr>
                <tr onclick="updateDetail('NVDA Option', 0.8)">
                    <td style="padding-left: 45px;"><i class="far fa-clock"></i> NVDA 260115 C140</td>
                    <td>(120,400)</td>
                    <td>8.5%</td>
                    <td><span class="method-badge">Proxy</span></td>
                    <td>-145,000</td>
                    <td>248</td>
                </tr>
                 <tr onclick="updateDetail('TSLA', 1.5)">
                    <td style="padding-left: 25px;"><i class="fas fa-share-alt"></i> TSLA</td>
                    <td>(320,100)</td>
                    <td>22.6%</td>
                    <td><span class="method-badge">Actual</span></td>
                    <td>-340,000</td>
                    <td>251</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="analysis-drawer">
        <div class="chart-box">
            <canvas id="varChart"></canvas>
        </div>
        <div class="stats-box">
            <h3 id="detailTitle" style="margin-top:0; color: var(--blue);">Portfolio Distribution</h3>
            <div class="stat-row"><span>Confidence Interval</span> <span>99.0%</span></div>
            <div class="stat-row"><span>Value at Risk (VaR)</span> <span style="color: var(--red);">-1,420,500</span></div>
            <div class="stat-row"><span>Expected Shortfall (ES)</span> <span style="color: var(--yellow);">-1,850,200</span></div>
            <div class="stat-row"><span>Worst Scenario</span> <span>Oct 20, 2024</span></div>
            <div style="margin-top: 15px; font-size: 11px; color: var(--text-dim); line-height: 1.4;">
                <i class="fas fa-info-circle"></i> 
                <strong>Methodology:</strong> Historical Simulation using weighted returns. 
                VaR is calculated as the negative of the alpha-quantile of the PnL distribution.
            </div>
        </div>
    </div>
</div>

<script>
    // --- 模拟数据: Customer -> Accounts 映射 ---
    const accountData = {
        'AAAA': ['11111-Margin', '11112-Cash', '11113-Deriv'],
        'BBBB': ['22222-Prime', '22223-SMA'],
        'CCCC': ['33333-Omnibus']
    };

    // --- 级联下拉框逻辑 ---
    function handleCustomerChange() {
        const customerSelect = document.getElementById('customerSelect');
        const accountSelect = document.getElementById('accountSelect');
        const selectedCustomer = customerSelect.value;

        // 清空 Account 选项
        accountSelect.innerHTML = '';

        if (selectedCustomer && accountData[selectedCustomer]) {
            // 启用 Account 选择框
            accountSelect.disabled = false;
            
            // 添加默认选项
            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.text = "-- Select Account --";
            defaultOpt.selected = true;
            accountSelect.appendChild(defaultOpt);

            // 填充对应账户
            accountData[selectedCustomer].forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc;
                opt.text = acc;
                accountSelect.appendChild(opt);
            });
        } else {
            // 重置为禁用状态
            resetAccountSelect();
        }
    }

    function resetAccountSelect() {
        const accountSelect = document.getElementById('accountSelect');
        accountSelect.innerHTML = '<option value="">-- Select Customer First --</option>';
        accountSelect.disabled = true;
        document.getElementById('portfolioName').innerText = "ALL ACCOUNTS";
    }

    function handleAccountChange() {
        const val = document.getElementById('accountSelect').value;
        if(val) {
            document.getElementById('portfolioName').innerText = "ACC: " + val;
            // 模拟重新拉取数据
            console.log("Fetching data for Account:", val);
        }
    }

    // --- 图表逻辑 (Chart.js) ---
    let chart;
    function initChart() {
        const ctx = document.getElementById('varChart').getContext('2d');
        const data = generateNormalData(); 
        
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'PnL Frequency',
                    data: data.values,
                    backgroundColor: (context) => {
                        // 简单的逻辑：尾部风险（左侧）标红
                        return context.index < 5 ? '#f85149' : '#1f6feb';
                    },
                    borderRadius: 2,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { display: false, grid: { display: false } },
                    x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', font: {size: 10} } }
                }
            }
        });
    }

    function generateNormalData() {
        let labels = [];
        let values = [];
        // 生成模拟的正态分布直方图数据
        for (let i = -40; i <= 40; i++) {
            labels.push(i);
            // 高斯函数模拟
            let val = Math.exp(-0.5 * Math.pow((i) / 10, 2)) * 1000;
            // 增加一点随机噪点
            values.push(val + Math.random() * 50);
        }
        return { labels, values };
    }

    function updateDetail(name, modifier) {
        document.getElementById('detailTitle').innerText = name + " - PnL Distribution";
        // 模拟点击不同资产时图表变化
        const newData = chart.data.datasets[0].data.map(v => v * (0.9 + Math.random() * 0.2));
        chart.data.datasets[0].data = newData;
        chart.update();
    }

    function simulateCalc() {
        const btn = document.querySelector('.btn-run');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CALC...';
        btn.style.opacity = "0.7";
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.opacity = "1";
            alert("Calculation completed for " + (document.getElementById('accountSelect').value || "All Accounts"));
        }, 800);
    }

    window.onload = initChart;
</script>

</body>
</html>
