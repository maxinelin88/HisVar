<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Historical VaR Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0d1117;
            --panel-bg: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --text-dim: #8b949e;
            --red: #f85149;
            --green: #3fb950;
            --blue: #58a6ff;
            --yellow: #d29922;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-size: 13px;
        }

        /* 页面参数 */
        .top-nav {
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .param-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .param-section {
            display: flex;
            align-items: center;
            gap: 10px;
            border-right: 1px solid var(--border);
            padding-right: 20px;
        }

        .param-section:last-child { border-right: none; }

        .label { color: var(--text-dim); font-weight: 600; font-size: 11px; text-transform: uppercase; }

        select, input {
            background: #010409;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 4px;
            outline: none;
        }

        .btn-run {
            background: #238636;
            color: white;
            border: none;
            padding: 6px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-run:hover { background: #2ea043; }

        /* 内容布局 */
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .grid-container { flex: 1; overflow: auto; padding: 10px; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #21262d; text-align: left; padding: 10px; position: sticky; top: 0; border-bottom: 2px solid var(--border); }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }

        .method-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(88, 166, 255, 0.15); color: var(--blue); border: 1px solid rgba(88, 166, 255, 0.3); }

        /* 分布图面板 */
        .analysis-drawer {
            height: 320px;
            background: #0d1117;
            border-top: 1px solid var(--border);
            display: flex;
            padding: 15px;
            gap: 20px;
        }

        .chart-box { flex: 2; position: relative; }
        .stats-box { flex: 1; background: #161b22; border-radius: 8px; padding: 15px; border: 1px solid var(--border); }

        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dotted var(--border); padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="top-nav">
    <div class="param-group">
        <div style="font-weight: bold; color: white; margin-right: 10px;"><i class="fas fa-microchip"></i> HIST-VAR</div>
        
        <div class="param-section">
            <span class="label">Model Inputs</span>
            <select id="lookback">
                <option value="252">1Y (252D)</option>
                <option value="504">2Y (504D)</option>
            </select>
            <input type="text" id="pnl_days" value="1D" style="width: 40px;" title="PnL Days">
            <select id="confidence">
                <option value="0.99">99.0% Confidence</option>
                <option value="0.95">95.0% Confidence</option>
            </select>
        </div>

        <div class="param-section">
            <span class="label">Filter</span>
            <input type="text" placeholder="Search Symbol...">
        </div>
    </div>

    <button class="btn-run" onclick="simulateCalc()"><i class="fas fa-play"></i> RUN CALC</button>
</div>

<div class="content">
    <div class="grid-container">
        <table>
            <thead>
                <tr>
                    <th>Asset Tree</th>
                    <th>VaR (USD)</th>
                    <th>Contribution</th>
                    <th>Method</th>
                    <th>Scenario PnL</th>
                    <th>$K_{eff}$</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background: rgba(56, 139, 253, 0.1);">
                    <td><strong><i class="fas fa-folder-open"></i> MASTER_FUND_A</strong></td>
                    <td style="color: var(--red); font-weight: bold;">(1,420,500)</td>
                    <td>100%</td>
                    <td>--</td>
                    <td>-1,450,200</td>
                    <td>251</td>
                </tr>
                <tr onclick="updateDetail('NVDA', 1.2)">
                    <td style="padding-left: 25px;"><i class="fas fa-share-alt"></i> NVDA</td>
                    <td>(980,000)</td>
                    <td>68.9%</td>
                    <td><span class="method-badge">Actual</span></td>
                    <td>-1,020,000</td>
                    <td>251</td>
                </tr>
                <tr onclick="updateDetail('NVDA Option', 0.8)">
                    <td style="padding-left: 45px;"><i class="far fa-clock"></i> NVDA 260115 C140</td>
                    <td>(120,400)</td>
                    <td>8.5%</td>
                    <td><span class="method-badge">Proxy</span></td>
                    <td>-145,000</td>
                    <td>248</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="analysis-drawer">
        <div class="chart-box">
            <canvas id="varChart"></canvas>
        </div>
        <div class="stats-box">
            <h3 id="detailTitle" style="margin-top:0; color: var(--blue);">Portfolio Distribution</h3>
            <div class="stat-row"><span>Confidence Interval ($\alpha$)</span> <span>99.0%</span></div>
            <div class="stat-row"><span>Value at Risk (VaR)</span> <span style="color: var(--red);">-1,420,500</span></div>
            <div class="stat-row"><span>Expected Shortfall (CVaR)</span> <span style="color: var(--yellow);">-1,850,200</span></div>
            <div class="stat-row"><span>Sample Skewness</span> <span>-0.85</span></div>
            <div style="margin-top: 15px; font-size: 11px; color: var(--text-dim);">
                <i class="fas fa-info-circle"></i> VaR Line is calculated as $PnL_{sorted}[Index]$ where $Index = \max(1, \lfloor K_{eff} \times 0.01 \rfloor)$.
            </div>
        </div>
    </div>
</div>

<script>
    let chart;
    function initChart() {
        const ctx = document.getElementById('varChart').getContext('2d');
        const data = generateNormalData(-1, 5, 100); // 模拟正态分布
        
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Frequency',
                    data: data.values,
                    backgroundColor: (ctx) => {
                        return ctx.index < 10 ? 'rgba(248, 81, 73, 0.7)' : 'rgba(56, 139, 253, 0.4)';
                    },
                    barPercentage: 1.0,
                    categoryPercentage: 1.0,
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { display: false },
                    x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                }
            }
        });
    }

    function generateNormalData(mu, sigma, n) {
        let labels = [];
        let values = [];
        for (let i = -30; i <= 30; i++) {
            labels.push(i + "M");
            // 简单的钟形曲线模拟，只是图例
            let val = Math.exp(-0.5 * Math.pow((i - 5) / 10, 2)) * 100;
            values.push(val + Math.random() * 10);
        }
        return { labels, values };
    }

    function updateDetail(name, riskFactor) {
        document.getElementById('detailTitle').innerText = name + " Distribution";
        chart.data.datasets[0].data = chart.data.datasets[0].data.map(v => v * (0.8 + Math.random() * 0.4));
        chart.update();
    }

    function simulateCalc() {
        alert("Recalculating VaR with K_eff = " + document.getElementById('lookback').value + " samples...");
    }

    window.onload = initChart;
</script>

</body>
</html>
