<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Historical VaR Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0d1117;
            --panel-bg: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --text-dim: #8b949e;
            --red: #f85149;
            --green: #3fb950;
            --blue: #58a6ff;
            --purple: #a371f7;
            --yellow: #d29922;
            --grey: #6e7681;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-size: 13px;
        }

        .top-nav {
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .nav-left { display: flex; align-items: center; gap: 15px; }
        .logo-area { font-weight: bold; color: white; font-size: 14px; margin-right: 10px; display: flex; align-items: center; gap: 8px; }

        .param-section {
            display: flex; align-items: center; gap: 8px;
            border-right: 1px solid var(--border); padding-right: 15px;
        }
        .param-section:last-child { border-right: none; }
        .label { color: var(--text-dim); font-weight: 600; font-size: 11px; text-transform: uppercase; white-space: nowrap; }

        select, input {
            background: #010409; border: 1px solid var(--border); color: var(--text);
            padding: 5px 10px; border-radius: 4px; outline: none; font-size: 12px;
        }
        select:disabled { background: #1c2128; color: #484f58; cursor: not-allowed; border-color: transparent; }

        .btn-run {
            background: #238636; color: white; border: none; padding: 6px 15px;
            border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; white-space: nowrap;
        }
        .btn-run:hover { background: #2ea043; }

        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .grid-container { flex: 1; overflow: auto; padding: 10px; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #21262d; text-align: left; padding: 10px; position: sticky; top: 0; border-bottom: 2px solid var(--border); z-index: 10;}
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        tr:hover { background-color: rgba(110, 118, 129, 0.1); cursor: pointer; }

        .method-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; border: 1px solid; font-weight: 600; }
        .badge-actual { background: rgba(88, 166, 255, 0.15); color: var(--blue); border-color: rgba(88, 166, 255, 0.3); }
        .badge-greeks { background: rgba(163, 113, 247, 0.15); color: var(--purple); border-color: rgba(163, 113, 247, 0.3); }
        .badge-reval { background: rgba(210, 153, 34, 0.15); color: var(--yellow); border-color: rgba(210, 153, 34, 0.3); }
        .badge-fallback { background: rgba(110, 118, 129, 0.1); color: var(--grey); border-color: var(--border); border-style: dashed;}

        .analysis-drawer {
            height: 300px; background: #0d1117; border-top: 1px solid var(--border);
            display: flex; padding: 15px; gap: 20px;
        }

        .chart-wrapper { flex: 2; position: relative; display: flex; align-items: center; justify-content: center; background: #010409; border: 1px solid var(--border); border-radius: 6px;}
        .chart-box { width: 100%; height: 100%; }
        
        .no-data-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(13, 17, 23, 0.95);
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-dim); z-index: 20;
        }

        .stats-box { flex: 1; background: #161b22; border-radius: 8px; padding: 15px; border: 1px solid var(--border); overflow-y: auto;}
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dotted var(--border); padding-bottom: 5px; }
        .warn-text { color: var(--yellow); font-size: 11px; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div class="top-nav">
    <div class="nav-left">
        <div class="logo-area"><i class="fas fa-layer-group"></i> RiskEngine</div>
        
        <div class="param-section">
            <span class="label">Scope</span>
            <select id="customerSelect" onchange="handleCustomerChange()">
                <option value="" selected disabled>Select Customer</option>
                <option value="AAAA">Customer AAAA</option>
                <option value="BBBB">Customer BBBB</option>
            </select>
            <select id="accountSelect" disabled onchange="handleAccountChange()">
                <option value="">-- Select Customer First --</option>
            </select>
            <select id="posBasis">
                <option value="Real-time">Real-time Pos</option>
                <option value="EOD">EOD (T-1) Pos</option>
            </select>
        </div>

        <div class="param-section">
            <span class="label">Params</span>
            <select id="lookback"><option value="252">1Y (252D)</option></select>
            <select id="confidence"><option value="0.99">99% Conf</option></select>
            <input type="text" id="pnl_days" value="1D" style="width: 30px; text-align: center;" title="Holding Period">
        </div>
    </div>
    <button class="btn-run" onclick="simulateCalc()"><i class="fas fa-play"></i> CALC</button>
</div>

<div class="content">
    <div class="grid-container">
        <table>
            <thead>
                <tr>
                    <th>Asset Hierarchy</th>
                    <th>VaR (USD)</th>
                    <th>Contribution</th>
                    <th>Method</th>
                    <th>days_eff</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background: rgba(56, 139, 253, 0.1);" onclick="updateDetail('Portfolio Total', 'normal')">
                    <td><strong><i class="fas fa-wallet"></i> <span id="portfolioName">ALL ACCOUNTS</span></strong></td>
                    <td style="color: var(--red); font-weight: bold;">(1,520,500)</td>
                    <td>100%</td>
                    <td>Aggregated</td>
                    <td>251</td>
                </tr>
                
                <tr onclick="updateDetail('NVDA', 'normal')">
                    <td style="padding-left: 25px;"><i class="fas fa-share-alt"></i> NVDA</td>
                    <td>(980,000)</td>
                    <td>64.5%</td>
                    <td><span class="method-badge badge-actual">Actual</span></td>
                    <td>251</td>
                </tr>

                <tr onclick="updateDetail('NVDA Option', 'normal')">
                    <td style="padding-left: 45px;"><i class="far fa-clock"></i> NVDA 260115 C140</td>
                    <td>(120,400)</td>
                    <td>7.9%</td>
                    <td><span class="method-badge badge-greeks">Greeks</span></td>
                    <td>251</td>
                </tr>

                 <tr onclick="updateDetail('TSLA Option', 'normal')">
                    <td style="padding-left: 45px;"><i class="far fa-clock"></i> TSLA 250620 P180</td>
                    <td>(85,000)</td>
                    <td>5.6%</td>
                    <td><span class="method-badge badge-reval">Full Reval</span></td>
                    <td>251</td>
                </tr>

                <tr onclick="updateDetail('ARM (IPO)', 'fallback')" style="background: rgba(255,255,255,0.02);">
                    <td style="padding-left: 25px; color: var(--text-dim);"><i class="fas fa-exclamation-triangle" style="color: var(--yellow)"></i> ARM (IPO)</td>
                    <td>(335,100)</td>
                    <td>22.0%</td>
                    <td><span class="method-badge badge-fallback">Fallback (30%)</span></td>
                    <td style="color: var(--text-dim);">0</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="analysis-drawer">
        <div class="chart-wrapper">
            <div class="chart-box">
                <canvas id="varChart"></canvas>
            </div>
            <div id="noDataOverlay" class="no-data-overlay">
                <i class="fas fa-ban fa-3x" style="margin-bottom: 15px; color: var(--border);"></i>
                <div style="font-size: 16px; font-weight: bold;">No Historical Distribution</div>
                <div style="margin-top: 5px; font-size: 12px; color: var(--text-dim);">
                    This asset uses <span style="color: var(--yellow);">Fallback Logic</span> (Fixed Rate).<br>
                    No simulation scenarios generated.
                </div>
            </div>
        </div>
        
        <div class="stats-box">
            <h3 id="detailTitle" style="margin-top:0; color: var(--blue);">Portfolio Distribution</h3>
            
            <div id="normalStats">
                <div class="stat-row"><span>Confidence Interval</span> <span>99.0%</span></div>
                <div class="stat-row"><span>Value at Risk (VaR)</span> <span style="color: var(--red);">-1,420,500</span></div>
                <div class="stat-row"><span>Expected Shortfall (ES)</span> <span style="color: var(--yellow);">-1,850,200</span></div>
                <div class="stat-row"><span>Worst Scenario</span> <span>Oct 20, 2024</span></div>
            </div>

            <div id="fallbackStats" style="display: none;">
                <div class="stat-row"><span>Calculation Type</span> <span style="color: var(--yellow);">Rule Based</span></div>
                <div class="stat-row"><span>Fixed Rate</span> <span>30.0%</span></div>
                <div class="stat-row"><span>Current Value</span> <span>1,117,000</span></div>
                <div class="stat-row"><span>Risk Value</span> <span style="color: var(--red);">-335,100</span></div>
                <div class="warn-text" style="display: block;">
                    <i class="fas fa-info-circle"></i> Result is linearly added to Total VaR.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const accountData = {
        'AAAA': ['11111-Margin', '11112-Cash'],
        'BBBB': ['22222-Prime']
    };

    function handleCustomerChange() {
        const customerSelect = document.getElementById('customerSelect');
        const accountSelect = document.getElementById('accountSelect');
        const selectedCustomer = customerSelect.value;
        accountSelect.innerHTML = '';

        if (selectedCustomer && accountData[selectedCustomer]) {
            accountSelect.disabled = false;
            const defaultOpt = document.createElement('option');
            defaultOpt.text = "-- Select Account --";
            accountSelect.appendChild(defaultOpt);
            accountData[selectedCustomer].forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc; opt.text = acc;
                accountSelect.appendChild(opt);
            });
        }
    }

    function handleAccountChange() {
        const val = document.getElementById('accountSelect').value;
        if(val) document.getElementById('portfolioName').innerText = "ACC: " + val;
    }

    let chart;
    function initChart() {
        const ctx = document.getElementById('varChart').getContext('2d');
        const data = generateNormalData(); 
        
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'PnL Frequency',
                    data: data.values,
                    backgroundColor: (ctx) => ctx.index < 5 ? '#f85149' : '#1f6feb',
                    barPercentage: 1.0, categoryPercentage: 1.0,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { display: false },
                    x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                }
            }
        });
    }

    function generateNormalData() {
        let labels = [], values = [];
        for (let i = -40; i <= 40; i++) {
            labels.push(i);
            values.push(Math.exp(-0.5 * Math.pow((i)/10, 2)) * 1000 + Math.random() * 50);
        }
        return { labels, values };
    }

    function updateDetail(name, type) {
        document.getElementById('detailTitle').innerText = name + (type === 'fallback' ? " Risk Detail" : " Distribution");
        const overlay = document.getElementById('noDataOverlay');
        const normalStats = document.getElementById('normalStats');
        const fallbackStats = document.getElementById('fallbackStats');

        if (type === 'fallback') {
            overlay.style.display = 'flex';
            normalStats.style.display = 'none';
            fallbackStats.style.display = 'block';
        } else {
            overlay.style.display = 'none';
            normalStats.style.display = 'block';
            fallbackStats.style.display = 'none';
            const newData = chart.data.datasets[0].data.map(v => v * (0.8 + Math.random() * 0.4));
            chart.data.datasets[0].data = newData;
            chart.update();
        }
    }

    function simulateCalc() {
        const basis = document.getElementById('posBasis').value;
        const btn = document.querySelector('.btn-run');
        const txt = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
        setTimeout(() => { 
            btn.innerHTML = txt; 
            alert(`Calculation Complete!\nBasis: ${basis} Positions`); 
        }, 500);
    }

    window.onload = initChart;
</script>

</body>
</html>
